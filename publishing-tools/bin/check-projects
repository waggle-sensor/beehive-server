#!/usr/bin/env python3
import argparse
import csv
import os


def get_node_ids_from_file(filename):
    with open(filename) as file:
        reader = csv.DictReader(file)
        return {row['node_id'] for row in reader}


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='''
    This tool performs a few sanity and incompleteness checks on projects' metadata.
    ''')
    parser.add_argument('project_dirs', nargs='*')
    args = parser.parse_args()

    for dir in map(os.path.abspath, args.project_dirs):
        nodes_ids = get_node_ids_from_file(os.path.join(dir, 'nodes.csv'))
        events_ids = get_node_ids_from_file(os.path.join(dir, 'events.csv'))

        no_commissioning_date = nodes_ids - events_ids
        no_node = events_ids - nodes_ids

        if no_node or no_commissioning_date:
            print('#', os.path.basename(dir))
            print()

        if no_commissioning_date:
            print('## No commissioning date')

            for id in sorted(no_commissioning_date):
                print(id)
            print()

        if no_node:
            print('## No node')

            for id in sorted(no_node):
                print(id)
            print()
