#!/usr/bin/env python3
import sys
import os
import subprocess
import argparse
import shutil
import publishing
import gzip

# resolve repo paths
program = os.path.abspath(sys.argv[0])
program_dir = os.path.dirname(os.path.dirname(program))


def needs_refresh(pair):
    src, dst = pair

    try:
        src_mtime = os.path.getmtime(src)
    except FileNotFoundError:
        return False

    try:
        dst_mtime = os.path.getmtime(dst)
    except FileNotFoundError:
        return True

    return dst_mtime < src_mtime


def make_project_digest(data_dir, base_dir, build_dir):
    projectID = os.path.split(os.path.split(base_dir)[0])[1]

    print('[{}] Preparing build tree.'.format(projectID))

    projdir = os.path.join(build_dir, projectID)
    os.makedirs(projdir, exist_ok=True)

    digest_dir = os.path.join(projdir, '{}.latest'.format(projectID))
    os.makedirs(digest_dir, exist_ok=True)

    staging_dir = os.path.join(projdir, 'staging')
    os.makedirs(staging_dir, exist_ok=True)

    print('[{}] Copy metadata.'.format(projectID))

    shutil.copy(os.path.join(program_dir, 'docs', 'digest-readme.md'), os.path.join(digest_dir, 'README.md'))
    shutil.copy(os.path.join(base_dir, 'nodes.csv'), os.path.join(digest_dir, 'nodes.csv'))
    shutil.copy(os.path.join(base_dir, 'sensors.csv'), os.path.join(digest_dir, 'sensors.csv'))

    print('[{}] Staging data files.'.format(projectID))

    nodes = publishing.load_project_metadata(os.path.join(program_dir, 'examples/plenario'))

    # sort candinate files in latest first order
    candidates = sorted(publishing.published_dates(nodes),
                        key=lambda item: item[1], reverse=True)

    file_pairs = []

    for node, date in candidates:
        src = os.path.join(data_dir, node['node_id'], date.strftime('%Y-%m-%d.csv.gz'))

        os.makedirs(os.path.join(projdir, 'staging', node['node_id']), exist_ok=True)
        dst = os.path.join(projdir, 'staging', node['node_id'], date.strftime('%Y-%m-%d.csv.gz'))
        file_pairs.append((src, dst))

    for src, dst in filter(needs_refresh, file_pairs):
        try:
            subprocess.check_output('''
            gzip -dc '{src}' |
            {program_dir}/bin/filter-sensors '{base_dir}sensors.csv' |
            {program_dir}/bin/filter-view '{base_dir}' |
            gzip > '{dst}.tmp'
            '''.format(src=src, dst=dst, program_dir=program_dir, base_dir=base_dir), shell=True)

            os.rename(dst + '.tmp', dst)

            print('ok', src)
        except Exception as exc:
            print('err', src, exc)

    print('[{}] Compiling staged files.'.format(projectID))

    with open(os.path.join(digest_dir, 'data.csv'), 'wb') as outfile:
        outfile.write(b'node_id,timestamp,plugin,sensor,parameter,value\n')

        for root, _, filenames in os.walk(staging_dir):
            for filename in filenames:
                if not filename.endswith('.csv.gz'):
                    continue
                with open(os.path.join(root, filename), 'rb') as infile:
                    data = gzip.decompress(infile.read())
                for line in data.splitlines():
                    fields = line.split(b';')
                    outfile.write(fields[0])
                    outfile.write(b',')
                    outfile.write(fields[1])
                    outfile.write(b',')
                    outfile.write(fields[2])
                    outfile.write(b',')
                    outfile.write(fields[4])
                    outfile.write(b',')
                    outfile.write(fields[5])
                    outfile.write(b',')
                    outfile.write(fields[6])
                    outfile.write(b'\n')

    print('[{}] Compiling archive.'.format(projectID))

    shutil.make_archive(base_name=os.path.join(projdir, '{}.latest'.format(projectID)),
                        format='gztar',
                        root_dir=digest_dir)


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('data_dir')
    parser.add_argument('base_dir')
    parser.add_argument('build_dir')
    args = parser.parse_args()

    make_project_digest(data_dir=args.data_dir,
                        base_dir=args.base_dir,
                        build_dir=args.build_dir)
